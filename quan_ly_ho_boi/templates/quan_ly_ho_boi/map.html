{% extends 'quan_ly_ho_boi/base.html' %}

{% block content %}
<h2 class="mb-3">Bản đồ Phân bố Hồ bơi (GIS)</h2>

<div class="card shadow-sm">
    <div class="p-2 bg-light border-bottom">
        <input type="text" id="searchBox" placeholder="Tìm hồ bơi theo tên..." class="form-control" onkeyup="searchPool()">
    </div>
    
    <div class="card-body p-0">
        <div id="map" style="height: 600px; width: 100%; z-index: 1;"></div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-measure/dist/leaflet-measure.css"/>

<style>
    .leaflet-control-measure .leaflet-control-measure-toggle {
        background-image: url(https://cdn.jsdelivr.net/npm/leaflet-measure/dist/images/measure.png);
        background-size: 16px 16px;
    }
</style>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-measure/dist/leaflet-measure.js"></script>

<script>
    var map;
    var poolLayer;

    document.addEventListener("DOMContentLoaded", function() {
        map = L.map('map').setView([16.47, 107.59], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        var measureControl = new L.Control.Measure({
            position: 'topright',
            primaryLengthUnit: 'meters',
            primaryAreaUnit: 'sqmeters',
            activeColor: '#db4a44',
            completedColor: '#8b2ce6',
            localization: 'en'
        });
        measureControl.addTo(map);
        poolLayer = L.geoJSON(null, {
            onEachFeature: function(feature, layer) {
                layer.bindPopup(
                    "<b>" + feature.properties.name + "</b><br>" +
                    "Trạng thái: " + feature.properties.status
                );
            }
        }).addTo(map);
        map.on('click', function(e) {
            var name = prompt("Nhập tên hồ bơi mới:");
            if(!name) return;
            
            var feature = {
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [e.latlng.lng, e.latlng.lat]
                },
                "properties": {
                    "name": name,
                    "status": "Hoạt động"
                }
            };
            poolLayer.addData(feature);
        });
        map.on('contextmenu', function(e) {
            var note = prompt("Mô tả sự cố tại vị trí này:");
            if(!note) return;
            L.marker(e.latlng).addTo(map)
                .bindPopup("<b style='color:red;'>Sự cố:</b><br>" + note)
                .openPopup();
        });
    });
    function searchPool() {
        var input = document.getElementById('searchBox').value.toLowerCase();
        
        poolLayer.eachLayer(function(layer) {
            var name = layer.feature.properties.name.toLowerCase();
            if (name.includes(input)) {
                if (layer.getElement()) layer.setOpacity(1);
            } else {
                if (layer.getElement()) layer.setOpacity(0.2);
            }
        });
    }
</script>
{% endblock %}