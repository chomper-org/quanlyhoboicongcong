{% extends 'quan_ly_ho_boi/base.html' %}

{% block content %}
<h2 class="mb-3">Bản đồ Phân bố Hồ bơi (GIS)</h2>

<div class="card shadow-sm">
    <div class="p-2 bg-light border-bottom">
        <input type="text" id="searchBox" placeholder="Tìm hồ bơi theo tên..." class="form-control" onkeyup="searchPool()">
    </div>
    
    <div class="card-body p-0">
        <div id="map" style="height: 600px; width: 100%; z-index: 1;"></div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-measure/dist/leaflet-measure.css"/>

<style>
    .leaflet-control-measure .leaflet-control-measure-toggle {
        background-image: url(https://cdn.jsdelivr.net/npm/leaflet-measure/dist/images/measure.png);
        background-size: 16px 16px;
    }
</style>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-measure/dist/leaflet-measure.js"></script>

<script>
    var map;
    var poolLayer;

    document.addEventListener("DOMContentLoaded", function() {
        map = L.map('map').setView([10.7769, 106.7009], 12);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        map.locate({setView: true, maxZoom: 16});
        map.on('mousemove', function(e) {
        currentMousePos = e.latlng;
        });
        poolLayer = L.geoJSON(null, {
        onEachFeature: function(feature, layer) {
            layer.bindPopup("<b>" + feature.properties.name + "</b>");
        }
        }).addTo(map);
        function onLocationFound(e) {
        var radius = e.accuracy / 2;
        L.marker(e.latlng).addTo(map)
            .bindPopup("Bạn đang ở trong phạm vi " + radius + " mét từ điểm này").openPopup();
        L.circle(e.latlng, radius).addTo(map);
        }
        function onLocationError(e) {
        alert("Không thể lấy vị trí của bạn: " + e.message + ". Bản đồ sẽ hiển thị TP.HCM mặc định.");
        }
        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);
        var measureControl = new L.Control.Measure({
        position: 'topright',
        primaryLengthUnit: 'meters',
        localization: 'en',
        popupOptions: {
            autoPan: false
            } 
        });
        measureControl.addTo(map);
    });
    function searchPool() {
        var input = document.getElementById('searchBox').value.toLowerCase();
        
        poolLayer.eachLayer(function(layer) {
            var name = layer.feature.properties.name.toLowerCase();
            if (name.includes(input)) {
                if (layer.getElement()) layer.setOpacity(1);
            } else {
                if (layer.getElement()) layer.setOpacity(0.2);
            }
        });
    }
    window.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT') return;
        if (!currentMousePos) return;
        const key = e.key.toLowerCase();
        if (key === 't') {
        var name = prompt("Nhập tên hồ bơi mới tại vị trí chuột:");
        if (!name) return;

        var feature = {
            "type": "Feature",
            "geometry": {
                "type": "Point",
                "coordinates": [currentMousePos.lng, currentMousePos.lat]
            },
            "properties": {
                "name": name,
                "status": "Hoạt động"
            }
        };
        poolLayer.addData(feature);
    }
    if (key === 'y') {
        var note = prompt("Mô tả sự cố tại vị trí chuột:");
        if (!note) return;

        L.marker(currentMousePos, {
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })
        }).addTo(map)
          .bindPopup("<b style='color:red;'>SỰ CỐ:</b><br>" + note)
          .openPopup();
        }
    });
</script>
{% endblock %}